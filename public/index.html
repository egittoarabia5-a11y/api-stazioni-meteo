<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dati stazioni CML</title>
</head>
<body>
  <pre id="output">Caricamento...</pre>

  <script>
    const latestData = {};

    function fittizioAReale(xFittizio, yFittizio) {
      const lon = ((8260 + xFittizio / 1.18) / 1000).toFixed(3);
      const lat = ((46730 - yFittizio / 1.72) / 1000).toFixed(3);
      return { lat, lon };
    }

    async function fetchCML() {
      try {
        const res = await fetch("/update.json");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        const text = json.data;

        const matchCoords = text.match(/var coords\s*=\s*(\[\[[\s\S]*?\]\]);/);
        const coords = JSON.parse(matchCoords[1].replace(/'/g, '"'));

        const matchData = text.match(/datostazione\s*=\s*(\[\[[\s\S]*?\]\]);/);
        const datostazione = JSON.parse(matchData[1].replace(/'/g, '"'));

        const lines = [];
        lines.push(new Date().toLocaleString()); // timestamp

        for (let i = 0; i < coords.length; i++) {
          const c = coords[i];
          const row = datostazione[i] || [];
          const nome = (c[1] || c[0]);
          const { lat, lon } = fittizioAReale(parseFloat(c[3]), parseFloat(c[4]));
          const isInactive = row[0] === '1' || row[0] === 1;

          const p = v => (v === null || v === undefined || v === '' ? 'null' : String(v));

          if (isInactive) {
            lines.push(`S:"1",N:"${nome}",T:"null",TH:"null",TL:"null",D:"null",DH:"null",DL:"null",H:"null",HH:"null",HL:"null",V:"null",G:"null",R:"null",RR:"null",LAT:"${p(lat)}",LON:"${p(lon)}"`);
          } else {
            lines.push(`S:"0",N:"${nome}",T:"${p(row[4])}",TH:"${p(row[5])}",TL:"${p(row[7])}",D:"${p(row[15])}",DH:"${p(row[16])}",DL:"${p(row[18])}",H:"${p(row[9])}",HH:"${p(row[10])}",HL:"${p(row[12])}",V:"${p(row[28])}",G:"${p(row[25])}",R:"${p(row[37])}",RR:"${p(row[41])}",LAT:"${p(lat)}",LON:"${p(lon)}"`);
          }
        }

        document.getElementById("output").textContent = lines.join("\n");
      } catch (err) {
        document.getElementById("output").textContent = "Errore: " + err.message;
        console.error(err);
      }
    }

    fetchCML();
    setInterval(fetchCML, 30000); // refresh ogni 30s
  </script>
</body>
</html>
